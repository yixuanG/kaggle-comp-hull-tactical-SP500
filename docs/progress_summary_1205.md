# Hull Tactical 市场预测项目 - 工作总结

## 项目背景

这是一个 Kaggle 竞赛项目，目标是预测 S&P 500 的超额收益，挑战有效市场假说（EMH）。

| 项目信息 | 说明 |
|---------|------|
| 竞赛目标 | 预测市场超额收益，设计投资策略跑赢 S&P 500 |
| 评估指标 | 改进版夏普比率（惩罚高波动率） |
| 仓位范围 | 0 ~ 200%（允许最多2倍杠杆） |
| 波动率约束 | ≤ 120% 市场波动率（赛事方会惩罚高波动策略）|

---

## 已完成工作

### 1. 数据准备

| 阶段 | 内容 | 产出文件 |
|-----|------|---------|
| 数据截取 | 准备两个时间窗口的数据 | - |
| - 长周期 | 2007-2025（覆盖金融危机、QE、疫情等） | `train_no_missing_2007_2025_final.csv` |
| - 短周期 | 2018-2025（更贴近当前市场环境） | `train_2018_2025_final.csv` |
| 缺失值处理 | 前向填充 + 中位数填充 | - |
| 异常值处理 | Winsorization（1%-99%分位数截断） | - |

数据概况：

| 数据集 | 交易日数 | 时间跨度 | 用途 |
|-------|---------|---------|------|
| 2007-2025 | ~4,625 | ~18年 | 长周期模型训练 |
| 2018-2025 | ~1,800 | ~7年 | 短周期模型训练 |

模型层：分别在两个时间窗口训练模型，最终做模型融合。训练结果可以理解为一个（或多个）经处理的高度嵌套Alpha因子
策略层：根据因子类型制定交易策略
交易层：在验证集上回测并得出买卖点和每次交易仓位

最终提交：180 个 date_id 的仓位预测值

### 2. 探索性分析（EDA）

完成了以下分析：
- 特征分组统计（D/E/I/M/P/S/V 七大类）
- 缺失值分布可视化
- 目标变量分布分析
- 特征相关性分析

### 3. 特征工程

基于原始 94 个特征，构建了多种衍生特征：

| 特征类型 | 说明 | 示例 |
|---------|------|------|
| 滞后特征 | lag1, lag5, lag20 | `P6_lag5` |
| 滚动统计 | mean, std (5d/20d/60d) | `P9_mean_20d` |
| 动量特征 | 20日变化率 | `P6_mom_20d` |
| Z-score | 20日标准化 | `P11_zscore_20d` |
| 排名特征 | 60d/200d 百分位排名 | `V13_rank_200d` |
| 加速度 | 5日变化加速度 | `P6_acc_5d` |
| 组合特征 | 多重变换叠加 | `P9_mean_20d_mom_20d` |

### 4. 特征选择

使用 LightGBM 进行特征重要性筛选：

| 指标 | 数值 |
|-----|------|
| 初始特征数 | ~600+ |
| 筛选后特征数 | 155 |
| 基准 RMSE | 0.00990 |
| 最终 RMSE | 0.00988 |

Top 10 重要特征：

| 排名 | 特征 | 重要性 |
|-----|------|--------|
| 1 | V13 | 0.00533 |
| 2 | P9_mean_20d_mom_20d | 0.00303 |
| 3 | M4 | 0.00268 |
| 4 | E19 | 0.00242 |
| 5 | P6_acc_5d | 0.00219 |
| 6 | P5_mean_5d | 0.00212 |
| 7 | P4_lag5 | 0.00190 |
| 8 | P11_std_5d | 0.00188 |
| 9 | P8 | 0.00179 |
| 10 | P6_mom_20d | 0.00171 |

---

## 数据文件结构

```
data/hull-tactical-market-prediction/
├── raw/                          # 原始数据
├── intermediate/                 # 中间处理数据
└── final/
    ├── train_no_missing_2007_2025_final.csv   # 训练集
    ├── test_holdout_final.csv                  # 测试集
    └── selected_features.json                  # 筛选后的特征列表
```

---

## 下一步：模型层-策略层-交易层设计

### 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         输入层                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  原始特征    │  │  衍生特征     │  │  市场状态    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        模型层 (Model Layer)                      │
│                                                                  │
│  目标：识别市场信号（不是直接预测收益）                            │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    信号识别模型                          │    │
│  │  • 趋势信号（动量/反转）                                 │    │
│  │  • 波动率信号（高/低波动环境）                           │    │
│  │  • 情绪信号（乐观/悲观）                                 │    │
│  │  • 宏观信号（扩张/收缩）                                 │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  (2018-25)  │  │  XGBoost    │  │ Transformer │              │
│  │  (2007-25)  │  │  LightGBM   │  │   (可选)     │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                              │                                   │
│                              ▼                                   │
│                    ┌─────────────────┐                          │
│                    │   模型融合       │                          │
│                    └─────────────────┘                          │
│                              │                                   │
│                    输出：信号强度 + 置信度                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       策略层 (Strategy Layer)                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    信号生成                              │    │
│  │  • 预测收益 → 方向信号（多/空/中性）                      │    │
│  │  • 置信度评估                                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    仓位计算                              │    │
│  │  • Kelly 公式 / 风险平价                                 │    │
│  │  • 波动率调整                                           │    │
│  │  • 仓位范围约束 [0, 2]                                   │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       交易层 (Trading Layer)                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    风险控制                              │    │
│  │  • 波动率约束（≤120% 市场波动率）                         │    │
│  │  • 最大回撤控制                                          │    │
│  │  • 仓位平滑（避免频繁交易）                               │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    执行输出                              │    │
│  │  • 最终仓位 allocation ∈ [0, 2]                          │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 各层详细设计

#### 模型层

核心思路：不直接预测收益，而是识别多种市场信号，再由策略层根据信号设计仓位。

| 信号类型 | 说明 | 可能的特征来源 |
|---------|----- / Cat-----------|
| 趋势信号 | 动量/反转判断 | P 类特征（价格相关） |
| 波动率信号 | 市场风险环境 | V 类特征（波动率相关） |
| 情绪信号 | 市场情绪状态 | S 类特征（情绪相关） |
| 宏观信号 | 经济周期位置 | E/M 类特征（经济/市场） |

| 模块 | 方案 | 说明 |
|-----|------|------|
| 长周期模型 | LightGBM (2007-2025) | 覆盖多种市场环境 |
| 短周| LightGBM (2018-2025) | 更贴近当前市场 |
| 深度模型 | LSTM / Transformer | 捕捉时序依赖（可选） |
| 融合方式 | 加权平均 / Stacking | 长短周期模型融合 |
| 验证方式 | 时序交叉验证 | 避免未来信息泄露 |

#### 策略层

核心思路：根据模型层输出的信号类型，设计对应的仓位策略。

| 信号组合 | 策略逻辑 | 仓位倾向 |
|---------|---------|--------/ σ²` 的保守版本 |
| 趋势↑ + 低波动 | 顺势加仓 | 1.5 ~ 2.0 |
| 趋势↑ + 高波动 | 谨慎做多 | 0.8 ~ 1.2 |
| 趋势↓ + 低波动 | 减仓观望 | 0.3 ~ 0.6 |
| 趋势↓ + 高波动 | 防守为主 | 0 ~ 0.3 |

| 模块 | 方案 | 说明 |
|-----|------|------|
| 信号解读 | 多信号综合判断 | 不同信号权重不同 |
| 仓位映射 | 信号强度 → 仓位 | 非线性映射函数 |
| 波动率调整 | 目标波动率缩放波动率动态调整 |
| 仓位约束 | clip(0, 2) | 满足竞赛要求 |

#### 交易层

| 模块 | 方案 | 说明 |
|-----|------|------|
| 波动率监控 | 滚动 20 日波动率 | 实时监控策略波动 |
| 仓位平滑 | 指数移动平均 | 避免仓位剧烈变化 |
| 风险预算 | 动态调整 | 高波动期降低仓位 |

### 实现优先级

```
Phase 1: 基础版本
├── LightGBM 单模型
├── 简单线性仓位映射
└── 基础波动率约束

Phase 2: 优化版本
├── 多模型集成
├── Kelly 仓位优化
└── 动态风险控制

Phase 3: 进阶版本
├── 深度学习模型
├── 市场状态识别
└── 自适应策略切换
```

---

## 待办事项

- [ ] 实现模型层基础框架
- [ ] 设计时序交叉验证方案
- [ ] 实现策略层仓位计算
- [ ] 实现交易层风控模块
- [ ] 本地回测验证
- [ ] 提交 Kaggle 测试
